<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.18/vue.min.js"></script>
<script src="/beta/javascripts/pinyin-convert.js" ></script>


<script>


    var lessonDashboardApp = new Vue({
        el: "#lessonDashboardApp",
        data: {
            vuex: JSON.parse(window.localStorage.getItem('vuex')),
            lesson: {},
            dialogue: {},
            vocab: {},
            expansion: {},
            grammar: {},
            downloads: {},
            questions: {},
            course: {},
            comments: {},
        },
        methods: {

            getAPIFetch: async function(api) {

                let results = await fetch(api,{
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer '+ (this.vuex ? this.vuex.token : '')
                    },
                })
                .then(resp => resp.json())
                .then(res => {
                    console.log("this res", res);
                    return res;
                })

                return results;

            },

            pinyinConvert: function(pinyin) {
                return PinyinConverter.convert(pinyin);
            },

            rewritePinyin: function(vocab) {
                console.log("called function");
                
                let writer = HanziWriter.create('target-'+vocab.id, vocab.t, {
                    width: 400,
                    height: 400,
                    renderer: 'svg',
                    radicalColor: '#166E16',
                    showCharacter: false,
                });
                console.log("rewrite", vocab);
            }

        },
        computed: {
            fetchLessons: async function(){
                this.lesson = await this.getAPIFetch('/api/v1/lessons/get-lesson?slug=<%= slug %>');
                // this.lesson = {"id":"1670","title":"Asking Height and Weight","slug":"asking-height-and-weight","introduction":"Just by being a foreigner in China, you're a fair target for all sorts of personal questions.  So don't be surprised when you're asked how tall you are, or how much you weigh.  In this lesson, learn to answer these questions.  Remember: for personal questions like these, truth is optional.","hash_code":"02e7a24f936f36a5c290b8863db5f3cfdaff5053","image":"https://s3contents.chinesepod.com/1670/02e7a24f936f36a5c290b8863db5f3cfdaff5053/images/3ls6s94iIcxyGbfnvXJVAg.jpg","type":"lesson","level":"Elementary","hosts":"Jason,Jenny","publication_timestamp":"2011-05-12T06:00:00.000Z","saved":false,"studied":false,"video":null,"mp3_dialogue":"https://s3contents.chinesepod.com/1670/02e7a24f936f36a5c290b8863db5f3cfdaff5053/mp3/chinesepod_B1670dg.mp3","mp3_public":"https://s3contents.chinesepod.com/1670/02e7a24f936f36a5c290b8863db5f3cfdaff5053/mp3/chinesepod_B1670pb.mp3","mp3_private":"https://s3contents.chinesepod.com/1670/02e7a24f936f36a5c290b8863db5f3cfdaff5053/mp3/chinesepod_B1670pr.mp3","mp3_thefix":"https://s3contents.chinesepod.com/1670/02e7a24f936f36a5c290b8863db5f3cfdaff5053/mp3/chinesepod_B1670rv.mp3","pdf1":"https://s3contents.chinesepod.com/1670/02e7a24f936f36a5c290b8863db5f3cfdaff5053/pdf/chinesepod_B1670.pdf","pdf2":"https://s3contents.chinesepod.com/1670/02e7a24f936f36a5c290b8863db5f3cfdaff5053/pdf/chinesepod_B1670trad.pdf","extra":false}

                if (this.lesson && this.lesson.id) {
                    console.log('here');
                    // next
                    // /api/v1/dashboard/course-lessons?courseId=978&exclude[0]=1670&limit=2
                    let courseId = '<%= courseId %>'
                    
                    if (courseId) this.course = await this.getAPIFetch('/api/v1/dashboard/course-lessons?courseId='+courseId+'&exclude[0]='+this.lesson.id+'&limit=2');
                    
                    this.dialogue = await this.getAPIFetch('/api/v1/lessons/get-dialogue?lessonId='+this.lesson.id);
                    this.vocab = await this.getAPIFetch('/api/v1/lessons/get-vocab?lessonId='+this.lesson.id);
                    this.expansion = await this.getAPIFetch('/api/v1/lessons/get-expansion?lessonId='+this.lesson.id);
                    this.grammar = await this.getAPIFetch('/api/v1/lessons/get-grammar?lessonId='+this.lesson.id);
                    this.downloads = await this.getAPIFetch('/api/v1/lessons/get-downloads?lessonId='+this.lesson.id);
                    this.comments = await this.getAPIFetch('/api/v1/lessons/get-comments?lessonId='+this.lesson.id);
                    // this.questions = await this.getAPIFetch('/api/v1/lessons/get-questions?lessonId='+this.lesson.id);
                    // console.log("vocab");
                    // this.vocab = [{"id":6970633,"s":"喜欢","t":"喜歡","p":"xǐhuan","en":"to like","audio":"mp3/glossary/source/chinesepod_1908_vocabulary_24545_prototype_3814.mp3","vocabulary_class":"Key Vocabulary"},{"id":6970632,"s":"吃","t":"吃","p":"chī","en":"to eat","audio":"mp3/glossary/source/chinesepod_1908_vocabulary_24546_prototype_6471_7445.mp3","vocabulary_class":"Key Vocabulary"},{"id":6970631,"s":"牛肉","t":"牛肉","p":"niúròu","en":"beef","audio":"mp3/glossary/source/chinesepod_1908_vocabulary_24547_prototype_8319_11319.mp3","vocabulary_class":"Key Vocabulary"},{"id":6970628,"s":"你呢","t":"你呢","p":"nǐ ne","en":"what about you?","audio":"mp3/glossary/source/chinesepod_1908_vocabulary_24548_prototype_20299_17314.mp3","vocabulary_class":"Key Vocabulary"},{"id":6970627,"s":"也","t":"也","p":"yě","en":"also","audio":"mp3/glossary/source/chinesepod_1908_vocabulary_24549_prototype_15041_19496.mp3","vocabulary_class":"Key Vocabulary"},{"id":6970626,"s":"鱼","t":"魚","p":"yú","en":"fish","audio":"mp3/glossary/source/chinesepod_1908_vocabulary_42559_prototype_21151_27001.mp3","vocabulary_class":"Key Vocabulary"},{"id":6970625,"s":"鸡肉","t":"雞肉","p":"jīròu","en":"chicken","audio":"mp3/glossary/source/chinesepod_1908_vocabulary_24550_prototype_4607_23868.mp3","vocabulary_class":"Supplementary"},{"id":6970624,"s":"鸭肉","t":"鴨肉","p":"yāròu","en":"duck meat","audio":"mp3/glossary/source/chinesepod_1908_vocabulary_24551_prototype_12455_33384.mp3","vocabulary_class":"Supplementary"},{"id":6970623,"s":"羊肉","t":"羊肉","p":"yángròu","en":"mutton","audio":"mp3/glossary/source/chinesepod_1908_vocabulary_24552_prototype_27071_41261.mp3","vocabulary_class":"Supplementary"},{"id":6970622,"s":"狗肉","t":"狗肉","p":"gǒuròu","en":"dog meat","audio":"mp3/glossary/source/chinesepod_1908_vocabulary_24553_prototype_48451_9318.mp3","vocabulary_class":"Supplementary"},{"id":6970621,"s":"猪肉","t":"豬肉","p":"zhūròu","en":"pork","audio":"mp3/glossary/source/chinesepod_1908_vocabulary_24554_prototype_50989_32759.mp3","vocabulary_class":"Supplementary"},{"id":6970630,"s":"蔬菜","t":"蔬菜","p":"shūcài","en":"vegetables","audio":"mp3/glossary/source/chinesepod_1908_vocabulary_24555_prototype_47498_7520.mp3","vocabulary_class":"Supplementary"},{"id":6970629,"s":"水果","t":"水果","p":"shuǐguǒ","en":"fruit","audio":"mp3/glossary/source/chinesepod_1908_vocabulary_24556_prototype_17647_24150.mp3","vocabulary_class":"Supplementary"}]
                    // this.grammar =[{"grammar":{"id":262,"name":"approximately","introduction":"大概 (dàgài) can mean \"approximately\" or \"about,\" indicating the speaker's best estimation.","tree":"Main Index > Parts of Speech > Adverbs > Types > General>大概 > 大概 (dàgài) > approximately","createdAt":"2010-03-18T20:52:41.000Z"},"examples":[{"target":"She's probably about twenty years old.","audio":"chinesepod_262_expansionbygrammar_293_prototype_4258.mp3","sentence":[{"s":"她","t":"她","p":"ta1","en":"she"},{"s":"大概","t":"大概","p":"da4gai4","en":"probably"},{"s":"二十岁","t":"二十歲","p":"er4shi2 sui4","en":"20 years old"},"。"],"en":"She's probably about twenty years old.","p":"ta1 da4gai4 er4shi2 sui4 。","s":"她大概二十岁。","t":"她大概二十歲。"},{"target":"Tomorrow it will be about 15 degrees.","audio":"chinesepod_262_expansionbygrammar_294_prototype_1929_9183_17972_11349.mp3","sentence":[{"s":"明天","t":"明天","p":"ming2tian1","en":"tomorrow"},{"s":"大概","t":"大概","p":"da4gai4","en":"probably"},{"s":"15","t":"15","p":"shi2wu3","en":"15"},{"s":"度","t":"度","p":"du4","en":"degrees"},"。"],"en":"Tomorrow it will be about 15 degrees.","p":"ming2tian1 da4gai4 shi2wu3 du4 。","s":"明天大概15度。","t":"明天大概15度。"},{"target":"He will probably arrive at 8 o'clock.","audio":"chinesepod_262_expansionbygrammar_295_prototype_17064_23329.mp3","sentence":[{"s":"他","t":"他","p":"ta1","en":"he"},{"s":"大概","t":"大概","p":"da4gai4","en":"probably"},{"s":"八点钟","t":"八點鐘","p":"ba1 dian3zhong1","en":"eight o‘clock"},{"s":"来","t":"來","p":"lai2","en":"to come"},"。"],"en":"He will probably arrive at 8 o'clock.","p":"ta1 da4gai4 ba1 dian3zhong1 lai2 。","s":"他大概八点钟来。","t":"他大概八點鐘來。"},{"target":"That meeting has been in session for about half an hour.","audio":"chinesepod_262_expansionbygrammar_296_prototype_38873_28636.mp3","sentence":[{"s":"那个","t":"那個","p":"na4ge5","en":"that"},{"s":"会","t":"會","p":"hui4","en":"meeting"},{"s":"大概","t":"大概","p":"da4gai4","en":"probably"},{"s":"开","t":"開","p":"kai1","en":"to hold"},{"s":"了","t":"了","p":"le5","en":""},{"s":"半个小时","t":"半個小時","p":"ban4 ge5 xiao3shi2","en":"half an hour"},"。"],"en":"That meeting has been in session for about half an hour.","p":"na4ge5 hui4 da4gai4 kai1 le5 ban4 ge5 xiao3shi2 。","s":"那个会大概开了半个小时。","t":"那個會大概開了半個小時。"},{"target":"I'm going to return to my home country at about the end of October.","audio":"chinesepod_262_expansionbygrammar_297_prototype_42001_8302.mp3","sentence":[{"s":"我","t":"我","p":"wo3","en":"I"},{"s":"大概","t":"大概","p":"da4gai4","en":"probably"},{"s":"10月底","t":"10月底","p":"shi2 yue4 di3","en":"at the end of October"},{"s":"回国","t":"回國","p":"hui2guo2","en":"to return to one’s home country"},"。"],"en":"I'm going to return to my home country at about the end of October.","p":"wo3 da4gai4 shi2 yue4 di3 hui2guo2 。","s":"我大概10月底回国。","t":"我大概10月底回國。"}],"updatedAt":"2010-03-18T20:52:41.000Z"},{"grammar":{"id":303,"name":"how (much)","introduction":"多 (duō) is used in interrogative sentences and inquires about an extent or amount, similar to \"how much\" in English.  Usually placed before an adjective.","tree":"Main Index > Parts of Speech > Adverbs > Types > General > 多 (duō) > how (much)","createdAt":"2010-03-18T20:52:42.000Z"},"examples":[{"target":"How tall is Yao Ming?","audio":"http://s3.amazonaws.com/chinesepod.com/0713/dfa68a56d8ca022c7f5516ac188b8eefe1c9ac6b/mp3/64/rec-1195799332984-16.mp3","sentence":[{"s":"姚明","t":"姚明","p":"Yao2 Ming2","en":"Yao Ming"},{"s":"有","t":"有","p":"you3","en":"to have"},{"s":"多高","t":"多高","p":"duo1 gao1","en":"how tall"},"？"],"en":"How tall is Yao Ming?","p":"Yao2 Ming2 you3 duo1 gao1 ？","s":"姚明有多高？","t":"姚明有多高？"},{"target":"How long do we have to wait?","audio":"http://s3.amazonaws.com/chinesepod.com/1120/c0687d5b718cdd9c7408faf2739d9ed5e57739eb/mp3/64/rec-1235609441515-8.mp3","sentence":[{"s":"要","t":"要","p":"yao4","en":"must"},{"s":"等","t":"等","p":"deng3","en":"to wait"},{"s":"多长时间","t":"多長時間","p":"duo1chang2 shi2jian1","en":"for how long"},"？"],"en":"How long do we have to wait?","p":"yao4 deng3 duo1chang2 shi2jian1 ？","s":"要等多长时间？","t":"要等多長時間？"},{"target":"How old is your father?","audio":"http://s3.amazonaws.com/chinesepod.com/1752/4b8800d722004f2217e1a24118ee9fda276109a0/mp3/64/chinesepod_6143_expansion_85560_prototype_7259_5605.mp3","sentence":[{"s":"你","t":"你","p":"ni3","en":"your"},{"s":"爸爸","t":"爸爸","p":"ba4ba5","en":"dad"},{"s":"多大","t":"多大","p":"duo1 da4","en":"how old"},{"s":"了","t":"了","p":"le5","en":""},"？"],"en":"How old is your father?","p":"ni3 ba4ba5 duo1 da4 le5 ？","s":"你爸爸多大了？","t":"你爸爸多大了？"},{"target":"How far is it from your home to the company?","audio":"http://s3.amazonaws.com/chinesepod.com/1120/c0687d5b718cdd9c7408faf2739d9ed5e57739eb/mp3/64/rec-1235609441515-7.mp3","sentence":[{"s":"从","t":"從","p":"cong2","en":"from"},{"s":"你","t":"你","p":"ni3","en":"your"},{"s":"家","t":"家","p":"jia1","en":"home"},{"s":"到","t":"到","p":"dao4","en":"to"},{"s":"公司","t":"公司","p":"gong1si1","en":"company"},{"s":"有","t":"有","p":"you3","en":"to have"},{"s":"多远","t":"多遠","p":"duo1yuan3","en":"how far"},"？"],"en":"How far is it from your home to the company?","p":"cong2 ni3 jia1 dao4 gong1si1 you3 duo1yuan3 ？","s":"从你家到公司有多远？","t":"從你家到公司有多遠？"},{"target":"How much does your son weigh?","audio":"http://s3.amazonaws.com/chinesepod.com/1670/02e7a24f936f36a5c290b8863db5f3cfdaff5053/mp3/64/chinesepod_5844_expansion_82231_prototype_57991_53145.mp3","sentence":[{"s":"你","t":"你","p":"ni3","en":"your"},{"s":"儿子","t":"兒子","p":"er2zi5","en":"son"},{"s":"多重","t":"多重","p":"duo1 zhong4","en":"how heavy"},"？"],"en":"How much does your son weigh?","p":"ni3 er2zi5 duo1 zhong4 ？","s":"你儿子多重？","t":"你兒子多重？"}],"updatedAt":"2010-03-18T20:52:42.000Z"},{"grammar":{"id":842,"name":"expressing degree, method, and amount","introduction":"这么(zhème) can be used to express the degree of a quality, the way of completing an action, or an amount of something.","tree":"Main Index > Parts of Speech > Pronouns > Types > Demonstrative Pronouns > 这么(zhème) > expressing degree, method, and amount","createdAt":"0000-00-00 00:00:00"},"examples":[{"target":"So dirty! Go wash your hands!","audio":"chinesepod_842_expansionbygrammar_2909_prototype_13479_29737.mp3","sentence":[{"s":"这么","t":"這麼","p":"zhe4me5","en":"so"},{"s":"脏","t":"髒","p":"zang1","en":"dirty"},"！",{"s":"去","t":"去","p":"qu4","en":"to go"},{"s":"洗","t":"洗","p":"xi3","en":"to wash"},{"s":"手","t":"手","p":"shou3","en":"hand"},"！"],"en":"So dirty! Go wash your hands!","p":"zhe4me5 zang1 ！qu4 xi3 shou3 ！","s":"这么脏！去洗手！","t":"這麼髒！去洗手！"},{"target":"So much luggage. It's such a hassle!","audio":"chinesepod_842_expansionbygrammar_2910_prototype_4661_28415.mp3","sentence":[{"s":"这么","t":"這麼","p":"zhe4me5","en":"so"},{"s":"多","t":"多","p":"duo1","en":"much"},{"s":"行李","t":"行李","p":"xing2li5","en":"luggage"},"，",{"s":"真","t":"真","p":"zhen1","en":"really"},{"s":"麻烦","t":"麻煩","p":"ma2fan5","en":"troublesome"},"！"],"en":"So much luggage. It's such a hassle!","p":"zhe4me5 duo1 xing2li5 ，zhen1 ma2fan5 ！","s":"这么多行李，真麻烦！","t":"這麼多行李，真麻煩！"},{"target":"It's so late. How come he hasn't come home yet?","audio":"chinesepod_842_expansionbygrammar_2911_prototype_21042_18942.mp3","sentence":[{"s":"这么","t":"這麼","p":"zhe4me5","en":"so"},{"s":"晚","t":"晚","p":"wan3","en":"late"},{"s":"了","t":"了","p":"le5","en":""},"，",{"s":"他","t":"他","p":"ta1","en":"he"},{"s":"怎么","t":"怎麼","p":"zen3me5","en":"how come"},{"s":"还","t":"還","p":"hai2","en":"still"},{"s":"没","t":"沒","p":"mei2","en":"not"},{"s":"回家","t":"回家","p":"hui2jia1","en":"to come home"},"？"],"en":"It's so late. How come he hasn't come home yet?","p":"zhe4me5 wan3 le5 ，ta1 zen3me5 hai2 mei2 hui2jia1 ？","s":"这么晚了，他怎么还没回家？","t":"這麼晚了，他怎麼還沒回家？"},{"target":"Your Chinese is so good!  Really amazing!","audio":"chinesepod_842_expansionbygrammar_2912_prototype_16099_8781_11082_1113.mp3","sentence":[{"s":"你","t":"你","p":"ni3","en":"your"},{"s":"中文","t":"中文","p":"Zhong1wen2","en":"Chinese"},{"s":"说","t":"說","p":"shuo1","en":"to speak"},{"s":"得","t":"得","p":"de5","en":""},{"s":"这么","t":"這麼","p":"zhe4me5","en":"so"},{"s":"好","t":"好","p":"hao3","en":"good"},"！",{"s":"真","t":"真","p":"zhen1","en":"really"},{"s":"厉害","t":"厲害","p":"li4hai5","en":"awesome"},"！"],"en":"Your Chinese is so good!  Really amazing!","p":"ni3 Zhong1wen2 shuo1 de5 zhe4me5 hao3 ！zhen1 li4hai5 ！","s":"你中文说得这么好！真厉害！","t":"你中文說得這麼好！真厲害！"},{"target":"How can you be so lazy?","audio":"chinesepod_842_expansionbygrammar_2913_prototype_10607.mp3","sentence":[{"s":"你","t":"你","p":"ni3","en":"you"},{"s":"怎么","t":"怎麼","p":"zen3me5","en":"how"},{"s":"这么","t":"這麼","p":"zhe4me5","en":"this, so"},{"s":"懒","t":"懶","p":"lan3","en":"lazy"},"？"],"en":"How can you be so lazy?","p":"ni3 zen3me5 zhe4me5 lan3 ？","s":"你怎么这么懒？","t":"你怎麼這麼懶？"}],"updatedAt":"2011-08-11T21:40:13.000Z"}]
                    // console.log("grammar", this.grammar);
                    let toggle_show_hide = document.querySelectorAll('.toggle-show-hide');

                    toggle_show_hide.forEach((toggle, i) => {
                        let isTranslationTextHidden = true;
                        toggle.onclick = () => {
                            let spanToHide = toggle.parentNode.querySelectorAll('span')[0];
                            let spanToShow = toggle.parentNode.querySelectorAll('span')[1];

                            if (isTranslationTextHidden) {
                                isTranslationTextHidden = false;

                                spanToShow.style.display = 'block';
                                spanToHide.style.display = 'none';

                                toggle.innerHTML = '<i class="bi bi-eye-fill"></i>';
                            } else {
                                isTranslationTextHidden = true;

                                spanToShow.style.display = 'none';
                                spanToHide.style.display = 'block';

                                toggle.innerHTML = '<i class="bi bi-eye-slash-fill"></i>';
                            }
                        }
                    });

                    // ## play audio in DIALOGUE tab
                    let play_audio = document.querySelectorAll('.play-audio');

                    play_audio.forEach((audio, i) => {
                        audio.onclick = () => {
                            let audio_player = audio.querySelector('audio');
                            // audio_player.play();
                            audio.classList.add('emit-audio');

                            audio_player.onended = () => {
                                audio.classList.remove('emit-audio');
                            }

                            let icon = audio.querySelector('i');
                            if (audio_player.duration > 0 && !audio_player.paused) {
                                audio_player.pause();
                                if (icon){
                                    icon.classList.add('bi-play-fill')
                                    icon.classList.remove('bi-pause-fill')
                                } 
                            } else {
                                if (icon){
                                    icon.classList.add('bi-pause-fill')
                                    icon.classList.remove('bi-play-fill')
                                } 
                                audio_player.play();
                            }
                        }
                    });
                } else {
                    console.log("lesson not found");
                }
            },

        }

    })

    lessonDashboardApp.fetchLessons
    // lessonDashboardApp.dialogue = lessonDashboardApp.getAPIFetch('/api/v1/lessons/get-dialogue?lessonId='+lessonDashboardApp.lesson.id);
    // var vuex = JSON.parse(window.localStorage.getItem('vuex'))
    // writer = HanziWriter.create('target', '牛', {
    //                 width: 400,
    //                 height: 400,
    //                 renderer: 'svg',
    //                 radicalColor: '#166E16',
    //                 onCorrectStroke: printStrokePoints,
    //                 onMistake: printStrokePoints,
    //                 showCharacter: false,
    //             });


// document.querySelector('.js-animate').addEventListener('click', function () {
//     writer.animateCharacter();
// });

function printStrokePoints(data) {
  var pointStrs = data.drawnPath.points.map((point) => `{x: ${point.x}, y: ${point.y}}`);
  console.log(`[${pointStrs.join(', ')}]`);
}

window.onload = function () {

    if (lessonDashboardApp.vocab.length) 
    lessonDashboardApp.vocab.forEach((vocab, i) => {
        let hanziCount = vocab.t.length
        
        for (let x=0; x < hanziCount; x++) {

            let writer = HanziWriter.create('target-'+x+'-'+vocab.id, vocab.t[x], {
                width: 100,
                height: 100,
                renderer: 'svg',
                radicalColor: '#166E16',
                onCorrectStroke: printStrokePoints,
                onMistake: printStrokePoints,
                showCharacter: false,
            });

            document.querySelector('.js-animate-'+x+'-'+vocab.id).addEventListener('click', function () {
                writer.animateCharacter();
            });
            
        }

    })


};

</script>