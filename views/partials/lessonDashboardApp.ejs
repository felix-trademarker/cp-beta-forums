<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.18/vue.min.js"></script>
<script src="/beta/javascripts/pinyin-convert.js" ></script>

<script>


    var lessonDashboardApp = new Vue({
        el: "#lessonDashboardApp",
        data: {
            vuex: JSON.parse(window.localStorage.getItem('vuex')),
            lesson: {},
            dialogue: {},
            vocab: {},
            expansion: {},
            grammar: {},
            downloads: {},
            questions: {},
            course: {},
        },
        methods: {

            getAPIFetch: async function(api) {

                let results = await fetch(api,{
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer '+ (this.vuex ? this.vuex.token : '')
                    },
                })
                .then(resp => resp.json())
                .then(res => {
                    console.log("this res", res);
                    return res;
                })

                return results;

            },

            pinyinConvert: function(pinyin) {
                return PinyinConverter.convert(pinyin);
            }

        },
        computed: {
            fetchLessons: async function(){
                this.lesson = await this.getAPIFetch('/api/v1/lessons/get-lesson?slug=<%= slug %>');
                console.log("await lesson", this.lesson);
                if (this.lesson && this.lesson.id) {

                    // next
                    // /api/v1/dashboard/course-lessons?courseId=978&exclude[0]=1670&limit=2

                    this.dialogue = await this.getAPIFetch('/api/v1/lessons/get-dialogue?lessonId='+this.lesson.id);
                    this.vocab = await this.getAPIFetch('/api/v1/lessons/get-vocab?lessonId='+this.lesson.id);
                    this.expansion = await this.getAPIFetch('/api/v1/lessons/get-expansion?lessonId='+this.lesson.id);
                    this.grammar = await this.getAPIFetch('/api/v1/lessons/get-grammar?lessonId='+this.lesson.id);
                    this.downloads = await this.getAPIFetch('/api/v1/lessons/get-downloads?lessonId='+this.lesson.id);
                    // this.questions = await this.getAPIFetch('/api/v1/lessons/get-questions?lessonId='+this.lesson.id);

                    let toggle_show_hide = document.querySelectorAll('.toggle-show-hide');

                    toggle_show_hide.forEach((toggle, i) => {
                        let isTranslationTextHidden = true;
                        toggle.onclick = () => {
                            let spanToHide = toggle.parentNode.querySelectorAll('span')[0];
                            let spanToShow = toggle.parentNode.querySelectorAll('span')[1];

                            if (isTranslationTextHidden) {
                                isTranslationTextHidden = false;

                                spanToShow.style.display = 'block';
                                spanToHide.style.display = 'none';

                                toggle.innerHTML = '<i class="bi bi-eye-fill"></i>';
                            } else {
                                isTranslationTextHidden = true;

                                spanToShow.style.display = 'none';
                                spanToHide.style.display = 'block';

                                toggle.innerHTML = '<i class="bi bi-eye-slash-fill"></i>';
                            }
                        }
                    });

                    // ## play audio in DIALOGUE tab
                    let play_audio = document.querySelectorAll('.play-audio');

                    play_audio.forEach((audio, i) => {
                        audio.onclick = () => {
                            let audio_player = audio.querySelector('audio');
                            audio_player.play();
                            audio.classList.add('emit-audio');

                            audio_player.onended = () => {
                                audio.classList.remove('emit-audio');
                            }
                        }
                    });
                }
            },
        }

    })

    lessonDashboardApp.fetchLessons
    // lessonDashboardApp.dialogue = lessonDashboardApp.getAPIFetch('/api/v1/lessons/get-dialogue?lessonId='+lessonDashboardApp.lesson.id);
    // var vuex = JSON.parse(window.localStorage.getItem('vuex'))
    

</script>